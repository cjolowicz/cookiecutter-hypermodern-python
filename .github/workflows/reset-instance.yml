name: Reset instance
on:
  push:
    branches:
      - master
jobs:
  instance:
    runs-on: ubuntu-latest
    steps:
      - name: Check out cookiecutter-hypermodern-python
        uses: actions/checkout@v2
        with:
          path: cookiecutter-hypermodern-python
      - name: Check out cookiecutter-hypermodern-python-instance
        uses: actions/checkout@v2
        with:
          repository: "cjolowicz/cookiecutter-hypermodern-python-instance"
          path: cookiecutter-hypermodern-python-instance
          token: {{ secrets.X_GITHUB_TOKEN }}
      - name: Remove working tree
        run: |
          mv cookiecutter-hypermodern-python-instance/.git tmp.git
          rm -rf cookiecutter-hypermodern-python-instance
          mkdir cookiecutter-hypermodern-python-instance
          mv tmp.git cookiecutter-hypermodern-python-instance/.git
      - name: Install cookiecutter
        run: pip install cookiecutter
      - name: Invoke cookiecutter
        run: >-
          cookiecutter
          cookiecutter-hypermodern-python
          --overwrite-if-exists
          --no-input
          project_name=cookiecutter-hypermodern-python-instance
      - name: Commit
        run: |
          cd cookiecutter-hypermodern-python-instance
          git config --local user.name "GitHub Action"
          git config --local user.email "action@github.com"
          git add .
          git commit --message="$GITHUB_REPOSITORY $GITHUB_SHA"
      - name: Push
        run: >-
          git
          -C cookiecutter-hypermodern-python-instance
          push
          https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/cjolowicz/cookiecutter-hypermodern-python-instance.git
          HEAD:master
